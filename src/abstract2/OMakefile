BYTE_ENABLED = true
NATIVE_ENABLED = true

USE_OCAMLFIND = true
OCAMLDEPFLAGS += -syntax camlp4o
OCAMLFLAGS += -thread -syntax camlp4o

LIBRARY = libabstract

OCAMLPACKS[] =
	str
	threads
	type_conv
	bin_prot
	sexplib
	sexplib.syntax
	oUnit

FILES[] =
	util
	core
	mask

section
	.DEFAULT: $(OCamlLibrary $(LIBRARY), $(FILES))

section
	DOC_DIRECTORY = doc
	DOC_FILES = $(filter-exists $(addsuffixes .ml .mli, $(FILES)))

	Document(doctype) = 
		warn = -warn-error A
		comma = ,
		OCAML_FIND_PACKAGES = -package $(concat $(comma),$(OCAMLPACKS))
		DOC_FLAGS = $(filter-out $(warn), $(OCAMLFLAGS))
		$(OCAMLFIND) ocamldoc $(DOC_FLAGS) $(OCAML_FIND_PACKAGES) \
			-$(doctype) -d $(DOC_DIRECTORY) $(DOC_FILES)

	Dependencies(format) =
		Document(dot)
		dot -T$(format) ocamldoc.out >$(LIBRARY).$(format)
		cp $(LIBRARY).$(format) ../../docs/modules
		rm ocamldoc.out

	.DEFAULT:
		Document(html -short-functors)
		Dependencies(pdf)

section
	PROGRAM = unit_test

	TEST_FILES[] =
		util_test
		core_test
		mask_test
		all_test

	.DEFAULT: $(OCamlProgram $(PROGRAM), $(FILES) $(TEST_FILES))
		./$(PROGRAM)
