BYTE_ENABLED = true
NATIVE_ENABLED = true

USE_OCAMLFIND = true
OCAMLDEPFLAGS += -syntax camlp4o
OCAMLFLAGS += -thread -syntax camlp4o

LIBRARY = libabstract

OCAMLPACKS[] =
	str
	threads
	type_conv
	bin_prot
	sexplib
	sexplib.syntax
	oUnit

FILES[] =
	util
	core
	mask
	action
	commandparse
	commandlex
	command

section
	.PHONY: commandparser

	commandparser:
		ocamlyacc -v commandparse.mly
		rm commandparse.mli
		ocamllex commandlex.mll

	.DEFAULT: commandparser $(OCamlLibrary $(LIBRARY), $(FILES))

section
	PROGRAM = unit_test
	DOC_DIRECTORY = doc

	TEST_FILES[] =
		util_test
		core_test
		mask_test
		command_test
		all_test

	comma = ,
	OCAML_FIND_PACKAGES = -package $(concat $(comma),$(OCAMLPACKS))
	.DEFAULT: $(OCamlProgram $(PROGRAM), $(FILES) $(TEST_FILES))
		ocamlfind ocamldoc \
			-thread -syntax camlp4o \
			$(OCAML_FIND_PACKAGES) \
			-html -d $(DOC_DIRECTORY) \
			*.mli
		./$(PROGRAM)
